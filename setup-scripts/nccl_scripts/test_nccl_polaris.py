
import matplotlib.pylab as plt
import numpy as np
import os


def getBW(path):
    os.system("grep float %s | awk '{print $1 \" \" $8}' > tmp.dat" %path)
    return np.loadtxt("tmp.dat").transpose()

def getTime(path):
    os.system("grep float %s | awk '{print $1 \" \" $6}' > tmp.dat" %path)
    return np.loadtxt("tmp.dat").transpose()

def getPerf(path, type='BW'):
    if type.find("BW")!=-1:
        return getBW(path)
    if type.find("LT")!=-1:
        return getTime(path)


    plt.figure(figsize=(15, 3), dpi=300)
plt.subplot(131)
plt.title("NCCL 2.21 - allreduce (8 nodes)")
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.1")
plt.plot(allreduce[0], allreduce[1], '-o', label='(1) Default')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.3")
plt.plot(allreduce[0], allreduce[1], '-o', label='(3) aws-ofi-nccl')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.4")
plt.plot(allreduce[0], allreduce[1], '-o', label='(4) aws-ofi-nccl + FI')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.5")
plt.plot(allreduce[0], allreduce[1], '-o', label='(5) aws-ofi-nccl + FI + alt_read')
plt.xscale('log')
plt.ylabel("busbw (GB/s)")
plt.xlabel("Bytes")
plt.legend()
plt.subplot(132)
plt.title("NCCL 2.21 - all_gather (8 nodes)")
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.1")
plt.plot(allreduce[0], allreduce[1], '-o', label='(1) Default')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.3")
plt.plot(allreduce[0], allreduce[1], '-o', label='(3) aws-ofi-nccl')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.4")
plt.plot(allreduce[0], allreduce[1], '-o', label='(4) aws-ofi-nccl + FI')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.5")
plt.plot(allreduce[0], allreduce[1], '-o', label='(5) aws-ofi-nccl + FI + alt_read')
plt.xscale('log')
plt.ylabel("busbw (GB/s)")
plt.xlabel("Bytes")
plt.legend()
plt.subplot(133)
plt.title("NCCL 2.21 - alltoall (8 nodes)")
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.1")
plt.plot(allreduce[0], allreduce[1], '-o', label='(1) Default')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.3")
plt.plot(allreduce[0], allreduce[1], '-o', label='(3) aws-ofi-nccl')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.4")
plt.plot(allreduce[0], allreduce[1], '-o', label='(4) aws-ofi-nccl + FI')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.5")
plt.plot(allreduce[0], allreduce[1], '-o', label='(5) aws-ofi-nccl + FI + alt_read')
plt.xscale('log')
plt.ylabel("busbw (GB/s)")
plt.xlabel("Bytes")
plt.legend(loc='upper left')
plt.show()


plt.figure(figsize=(15, 3), dpi=300)
plt.subplot(131)
plt.title("NCCL 2.21 - allreduce (8 nodes)")
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.1", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(1) Default')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.3",  "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(3) aws-ofi-nccl')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.4", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(4) aws-ofi-nccl + FI')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_reduce_output.dat.5", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(5) aws-ofi-nccl + FI + alt_read')
plt.xscale('log')
plt.yscale('log')

plt.ylabel("time (us)")
plt.xlabel("Bytes")
plt.legend()
plt.subplot(132)
plt.title("NCCL 2.21 - all_gather (8 nodes)")
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.1", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(1) Default')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.3", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(3) aws-ofi-nccl')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.4", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(4) aws-ofi-nccl + FI')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/all_gather_output.dat.5", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(5) aws-ofi-nccl + FI + alt_read')
plt.xscale('log')
plt.yscale('log')

plt.ylabel("time (us)")
plt.xlabel("Bytes")
plt.legend()
plt.subplot(133)
plt.title("NCCL 2.21 - alltoall (8 nodes)")
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.1", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(1) Default')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.3", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(3) aws-ofi-nccl')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.4", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(4) aws-ofi-nccl + FI')
allreduce = getPerf("./results_polaris/nccl_2_21/n8.g4.2024-04-29-21-23-48/alltoall_output.dat.5", "LT")
plt.plot(allreduce[0], allreduce[1], '-o', label='(5) aws-ofi-nccl + FI + alt_read')
plt.xscale('log')
plt.yscale('log')

plt.ylabel("time (us)")
plt.xlabel("Bytes")
plt.legend(loc='upper left')
plt.show()
